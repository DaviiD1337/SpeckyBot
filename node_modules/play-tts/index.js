const fs = require('fs');
const path = require('path');
const gTTS = require('gtts');
const player = require('play-sound')({player: path.join(path.dirname(fs.realpathSync(__filename)), '../play-tts') + "/mplayer/mplayer.exe"});
const mp3Duration = require('mp3-duration');

exports.play = function (str, lang, callback){
  //define where to save to
  var filePath = path.join(path.dirname(fs.realpathSync(__filename)), '../play-tts')  + '/audio/TTS.mp3';

  //create new TTS audio
  var language;
  if(lang){
    language = lang;
  }else{
    language = 'en';
  }
  var gtts = new gTTS(str, lang);

  //Save to file path
  gtts.save(filePath, function (err, result) {
    if(err) throw err;

    //detect duration to limit audio playback loop glitches by killing audio 200ms after duration
    mp3Duration(filePath, function (err, duration) {
      if (err) throw err;

      //play audio
      var audio;

      setTimeout(function(){audio.kill()},duration*1000+200);

      audio = player.play(filePath, function (err) {
        if (err) throw err;

        if(typeof callback !== 'undefined'){
          callback();
        };

      });

    });

  });

}
